FROM ubuntu:24.04

ARG WOLFSSL_VERSION
ARG HTTP_PROXY
ARG HTTPS_PROXY

RUN echo WolfSSL Version: $WOLFSSL_VERSION

# Change the Ubuntu package mirror
RUN apt update && apt install -y apt-transport-https ca-certificates
RUN sed -i 's@//.*archive.ubuntu.com@//mirrors.ustc.edu.cn@g' /etc/apt/sources.list.d/ubuntu.sources && \
    sed -i 's/security.ubuntu.com/mirrors.ustc.edu.cn/g' /etc/apt/sources.list.d/ubuntu.sources && \
    apt clean

# Install common dependencies
ENV DEBIAN_FRONTEND=noninteractive
RUN apt-get update && apt-get install -y \
    wget ca-certificates gnupg2 \
    apt-utils git build-essential curl sudo bison flex autoconf automake \
    libtool pkg-config git vim gdb lsb-release software-properties-common tcpdump \
    && rm -rf /var/lib/apt/lists

# Add a new user user, pass: user
RUN groupadd -g 1013 user && \
    useradd -u 1013 -rm -d /home/user -s /usr/bin/zsh -g user -G sudo user -p "$(openssl passwd -1 user)" && \
    echo "user ALL=(ALL) NOPASSWD:ALL" >> /etc/sudoers
USER user
WORKDIR /home/user

RUN git config --global http.version HTTP/1.1 

# Clone wolfssl code repository from github
# gitee.com/zzroot/wolfssl.git is the mirror of github.com/wolfSSL/wolfssl.git
RUN git clone -b $WOLFSSL_VERSION --single-branch --depth 1 https://gitee.com/zzroot/wolfssl.git

RUN cd wolfssl && \
    git describe --tags

COPY poc.patch /home/user/

RUN cp -r /home/user/wolfssl /home/user/wolfssl-server && \
    cd /home/user/wolfssl-server && \
    ./autogen.sh && \
    CFLAGS="-O0 -fsanitize=address -g -DDEBUG -DDEBUG_WOLFSSL" \
    CXXFLAGS="-O0 -fsanitize=address -g -DDEBUG -DDEBUG_WOLFSSL" \
    ./configure --enable-static --enable-session-ticket --enable-tls13 --enable-opensslextra --enable-tlsv12=no && \
    make -j examples/server/server

RUN cp -r /home/user/wolfssl /home/user/wolfssl-client && \ 
    cd /home/user/wolfssl-client && \
    ./autogen.sh && \
    git apply /home/user/poc.patch && \
    CFLAGS="-O0 -g -fvisibility=default -DDEBUG -DDEBUG_WOLFSSL" \
    CXXFLAGS="-O0 -g -fvisibility=default -DDEBUG -DDEBUG_WOLFSSL" \
    ./configure --enable-static --enable-session-ticket --enable-tls13 --enable-opensslextra --enable-tlsv12=no && \
    make -j examples/client/client

RUN openssl req -x509 \
    -nodes \
    -days 365 \
    -newkey rsa:2048 \
    -keyout private.key \
    -out certificate.crt \
    -subj "/C=CN/ST=Beijing/L=Beijing/O=MyCompany/OU=IT/CN=localhost"

COPY --chown=user:user mal-client-server.sh /home/user/
RUN chmod +x /home/user/mal-client-server.sh

ENV ASAN_OPTIONS='abort_on_error=1:symbolize=1:detect_leaks=0:detect_stack_use_after_return=1:detect_container_overflow=0:poison_array_cookie=0:malloc_fill_byte=0:max_malloc_fill_size=16777216'
ENTRYPOINT [ "/bin/bash", "-c", "/home/user/mal-client-server.sh" ]
