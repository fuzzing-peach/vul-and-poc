#!/bin/bash

mkdir -p /tmp/result

# Start tcpdump in background and capture its PID
sudo tcpdump -i lo port 4433 -w /tmp/result/tcpdump.pcap &
TCPDUMP_PID=$!

sleep 2

echo "Starting server..."
# Launch the wolfssl server in the background
cd ${HOME}/wolfssl-server/ && \
    ${HOME}/wolfssl-server/examples/server/server \
        -A ${HOME}/certificate.crt \
        -k ${HOME}/private.key \
        -c ${HOME}/certificate.crt \
        -d -r -C 10 \
        -e -p 4433 > /tmp/result/server.log 2> /tmp/result/server.err &

# Store the server's PID
SERVER_PID=$!

# Wait a moment for the server to start
sleep 2

# Check if server is running
if ! kill -0 $SERVER_PID 2>/dev/null; then
    echo "Server failed to start"
    exit 1
fi

echo "Starting client..."
# Launch the client in the foreground
cd ${HOME}/wolfssl-client/ && \
    ${HOME}/wolfssl-client/examples/client/client \
        -A ${HOME}/certificate.crt \
        -p 4433 -r > /tmp/result/client.log 2> /tmp/result/client.err

sleep 2
# Clean up the server process when done
kill $SERVER_PID

sleep 2
# Clean up tcpdump process
sudo kill $TCPDUMP_PID

# Wait for processes to be killed
wait $SERVER_PID
wait $TCPDUMP_PID
