IMAGE=wolfssl-cve-2022-39173
WOLFSSL_VERSION=v5.4.0-stable

if ! docker image inspect "${IMAGE}" &> /dev/null; then
    cmd="docker build -t $IMAGE --build-arg WOLFSSL_VERSION=$WOLFSSL_VERSION --network=host --build-arg HTTP_PROXY=http://127.0.0.1:7890 --build-arg HTTPS_PROXY=http://127.0.0.1:7890 ."
    echo "[+] Running: $cmd"
    eval $cmd
fi

echo "[+] Running container"
docker run -it $IMAGE
# Get container ID of the most recently started container using the image
CONTAINER_ID=$(docker ps -a -q -f ancestor=$IMAGE -l)

if [ -z "$CONTAINER_ID" ]; then
    echo "[-] No running container found for image $IMAGE"
    exit 1
fi

echo "[+] Container ID: $CONTAINER_ID"

# copy the tcpdump.pcap to the host
docker cp $CONTAINER_ID:/tmp/tcpdump.pcap ./CVE-2022-39173.pcap

# kill the container
docker kill $CONTAINER_ID
